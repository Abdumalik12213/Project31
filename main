
import tkinter as tk
from tkinter import ttk, messagebox, filedialog, scrolledtext
import sqlite3
import requests
from bs4 import BeautifulSoup
from datetime import datetime, timedelta
import json
import os
from PIL import Image, ImageTk, ImageOps
import io
import threading
import time
import re
import sys
import csv
import webbrowser
from urllib.parse import urlparse
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import pandas as pd
import numpy as np
from dataclasses import dataclass
from typing import Optional, List, Dict, Tuple
import logging
import urllib3
from urllib3.exceptions import InsecureRequestWarning

# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ SSL
urllib3.disable_warnings(InsecureRequestWarning)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('price_monitor.log'),
        logging.StreamHandler()
    ]
)

@dataclass
class Product:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–≤–∞—Ä–µ"""
    id: int
    name: str
    url: str
    current_price: Optional[float]
    previous_price: Optional[float]
    currency: str
    last_updated: str
    selector_type: str
    selector_path: str
    image_data: Optional[bytes] = None
    category: str = "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"

class PriceMonitorApp:
    def __init__(self, root):
        self.root = root
        self.root.title("üí∞ Smart Price Monitor Pro")
        self.root.geometry("1400x800")
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∏–ª—è
        self.setup_styles()
        
        # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–∫–Ω–∞
        self.center_window()
        
        # –ò–∫–æ–Ω–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        self.set_icon()
        
        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        self.conn = None
        self.create_database()
        
        # –ö—ç—à –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        self.image_cache = {}
        self.current_product_id = None
        self.update_thread = None
        self.stop_update = False
        self.products = []
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        self.config = self.load_config()
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        self.create_widgets()
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        self.load_products()
        
        # –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
        if self.config.get('auto_update', False):
            self.start_auto_update()
    
    def setup_styles(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∏–ª–µ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        self.style = ttk.Style()
        self.style.theme_use('clam')
        
        # –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞
        self.colors = {
            'primary': '#2c3e50',
            'secondary': '#3498db',
            'success': '#2ecc71',
            'danger': '#e74c3c',
            'warning': '#f39c12',
            'light': '#ecf0f1',
            'dark': '#34495e',
            'background': '#f5f6fa',
            'card': '#ffffff'
        }
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∏–ª–µ–π –≤–∏–¥–∂–µ—Ç–æ–≤
        self.style.configure('Title.TLabel', 
                           font=('Segoe UI', 24, 'bold'),
                           foreground=self.colors['primary'])
        
        self.style.configure('Subtitle.TLabel',
                           font=('Segoe UI', 14),
                           foreground=self.colors['dark'])
        
        self.style.configure('Card.TFrame',
                           background=self.colors['card'],
                           relief='raised',
                           borderwidth=1)
        
        self.style.configure('Primary.TButton',
                           font=('Segoe UI', 10, 'bold'),
                           background=self.colors['secondary'],
                           foreground='white',
                           borderwidth=0)
        
        self.style.map('Primary.TButton',
                      background=[('active', '#2980b9')])
        
        self.style.configure('Success.TButton',
                           font=('Segoe UI', 10, 'bold'),
                           background=self.colors['success'],
                           foreground='white',
                           borderwidth=0)
        
        self.style.configure('Danger.TButton',
                           font=('Segoe UI', 10, 'bold'),
                           background=self.colors['danger'],
                           foreground='white',
                           borderwidth=0)
        
        self.style.configure('Warning.TButton',
                           font=('Segoe UI', 10, 'bold'),
                           background=self.colors['warning'],
                           foreground='white',
                           borderwidth=0)
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Treeview
        self.style.configure('Treeview',
                           font=('Segoe UI', 10),
                           rowheight=30,
                           background=self.colors['light'],
                           fieldbackground=self.colors['light'])
        
        self.style.configure('Treeview.Heading',
                           font=('Segoe UI', 11, 'bold'),
                           background=self.colors['primary'],
                           foreground='white',
                           relief='flat')
        
        self.style.map('Treeview.Heading',
                      background=[('active', self.colors['dark'])])
    
    def center_window(self):
        """–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–∫–Ω–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ"""
        self.root.update_idletasks()
        screen_width = self.root.winfo_screenwidth()
        screen_height = self.root.winfo_screenheight()
        window_width = 1400
        window_height = 800
        
        x = (screen_width - window_width) // 2
        y = (screen_height - window_height) // 2
        
        self.root.geometry(f'{window_width}x{window_height}+{x}+{y}')
    
    def set_icon(self):
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∫–æ–Ω–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
        try:
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –∏–∫–æ–Ω–∫—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö
            icon_data = """
                R0lGODlhIAAgAIAAAAAAAP///yH5BAAAAAAALAAAAAAgACAAAAMLjI+py+0Po5y0
                ugUAOw==
            """
            self.root.iconbitmap(default='')
        except:
            pass
    
    def create_database(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
        try:
            self.conn = sqlite3.connect('price_monitor.db', check_same_thread=False)
            self.conn.execute("PRAGMA foreign_keys = ON")
            cursor = self.conn.cursor()
            
            # –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS products (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    url TEXT NOT NULL,
                    category TEXT DEFAULT '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',
                    image_url TEXT,
                    image_data BLOB,
                    current_price REAL,
                    previous_price REAL,
                    currency TEXT DEFAULT 'RUB',
                    last_updated TEXT,
                    selector_type TEXT DEFAULT 'CSS',
                    selector_path TEXT,
                    min_price REAL,
                    max_price REAL,
                    target_price REAL,
                    is_active INTEGER DEFAULT 1,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            # –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS price_history (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    product_id INTEGER,
                    price REAL NOT NULL,
                    date TEXT NOT NULL,
                    FOREIGN KEY (product_id) REFERENCES products (id) ON DELETE CASCADE,
                    UNIQUE(product_id, date)
                )
            ''')
            
            # –¢–∞–±–ª–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS settings (
                    key TEXT PRIMARY KEY,
                    value TEXT
                )
            ''')
            
            # –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            cursor.execute('CREATE INDEX IF NOT EXISTS idx_products_category ON products(category)')
            cursor.execute('CREATE INDEX IF NOT EXISTS idx_products_active ON products(is_active)')
            cursor.execute('CREATE INDEX IF NOT EXISTS idx_price_history_product_date ON price_history(product_id, date)')
            
            self.conn.commit()
            
        except sqlite3.Error as e:
            logging.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
            messagebox.showerror("–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö", f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:\n{e}")
            sys.exit(1)
    
    def load_config(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        config = {
            'update_interval': 300,
            'auto_update': False,
            'notifications': True,
            'currency': 'RUB',
            'theme': 'light'
        }
        
        try:
            cursor = self.conn.cursor()
            cursor.execute("SELECT key, value FROM settings")
            rows = cursor.fetchall()
            
            for key, value in rows:
                if key in config:
                    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤
                    if key in ['update_interval']:
                        config[key] = int(value)
                    elif key in ['auto_update', 'notifications']:
                        config[key] = bool(int(value))
                    else:
                        config[key] = value
                        
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
        
        return config
    
    def save_config(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
        try:
            cursor = self.conn.cursor()
            for key, value in self.config.items():
                # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ boolean –≤ int –¥–ª—è SQLite
                if isinstance(value, bool):
                    value = int(value)
                cursor.execute(
                    "INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)",
                    (key, str(value))
                )
            self.conn.commit()
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
    
    def create_widgets(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        main_container = ttk.Frame(self.root)
        main_container.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
        self.create_header(main_container)
        
        # –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
        content_frame = ttk.Frame(main_container)
        content_frame.pack(fill=tk.BOTH, expand=True, pady=(10, 0))
        
        # –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        left_panel = ttk.Frame(content_frame, width=350)
        left_panel.pack(side=tk.LEFT, fill=tk.BOTH, padx=(0, 10))
        left_panel.pack_propagate(False)
        
        self.create_control_panel(left_panel)
        
        # –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –¥–∞–Ω–Ω—ã–µ –∏ –≥—Ä–∞—Ñ–∏–∫–∏
        right_panel = ttk.Frame(content_frame)
        right_panel.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True)
        
        self.create_data_panel(right_panel)
        
        # –°—Ç–∞—Ç—É—Å –±–∞—Ä
        self.create_status_bar(main_container)
    
    def create_header(self, parent):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏"""
        header_frame = ttk.Frame(parent, style='Card.TFrame')
        header_frame.pack(fill=tk.X, pady=(0, 10))
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ª–æ–≥–æ—Ç–∏–ø
        title_frame = ttk.Frame(header_frame)
        title_frame.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=20, pady=10)
        
        ttk.Label(title_frame, text="üí∞", font=('Segoe UI', 36)).pack(side=tk.LEFT, padx=(0, 10))
        
        title_text = ttk.Label(title_frame, 
                              text="Smart Price Monitor Pro",
                              style='Title.TLabel')
        title_text.pack(side=tk.LEFT)
        
        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        button_frame = ttk.Frame(header_frame)
        button_frame.pack(side=tk.RIGHT, padx=20, pady=10)
        
        ttk.Button(button_frame, text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", 
                  command=self.show_statistics, style='Primary.TButton').pack(side=tk.LEFT, padx=5)
        
        ttk.Button(button_frame, text="‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏", 
                  command=self.show_settings, style='Primary.TButton').pack(side=tk.LEFT, padx=5)
        
        ttk.Button(button_frame, text="üì§ –≠–∫—Å–ø–æ—Ä—Ç", 
                  command=self.export_data, style='Success.TButton').pack(side=tk.LEFT, padx=5)
    
    def create_control_panel(self, parent):
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"""
        # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
        categories_frame = ttk.LabelFrame(parent, text="üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏", padding=15)
        categories_frame.pack(fill=tk.X, pady=(0, 10))
        
        self.category_var = tk.StringVar(value="–í—Å–µ —Ç–æ–≤–∞—Ä—ã")
        self.category_combo = ttk.Combobox(categories_frame, 
                                          textvariable=self.category_var,
                                          state="readonly",
                                          font=('Segoe UI', 10))
        self.category_combo.pack(fill=tk.X)
        self.category_combo.bind('<<ComboboxSelected>>', self.filter_by_category)
        
        # –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
        form_frame = ttk.LabelFrame(parent, text="‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä", padding=15)
        form_frame.pack(fill=tk.X, pady=(0, 10))
        
        # –ü–æ–ª—è —Ñ–æ—Ä–º—ã
        fields = [
            ("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:", "name"),
            ("URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã:", "url"),
            ("–ö–∞—Ç–µ–≥–æ—Ä–∏—è:", "category"),
            ("CSS-—Å–µ–ª–µ–∫—Ç–æ—Ä —Ü–µ–Ω—ã:", "selector"),
            ("–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞:", "target_price")
        ]
        
        self.form_vars = {}
        for i, (label, key) in enumerate(fields):
            ttk.Label(form_frame, text=label).grid(row=i, column=0, sticky=tk.W, pady=5)
            
            if key == 'category':
                var = tk.StringVar()
                entry = ttk.Combobox(form_frame, textvariable=var, state="normal")
                entry['values'] = self.get_categories()
            elif key == 'selector':
                var = tk.StringVar(value=".price, .product-price, [itemprop='price']")
                entry = ttk.Entry(form_frame, textvariable=var, font=('Segoe UI', 10))
            else:
                var = tk.StringVar()
                entry = ttk.Entry(form_frame, textvariable=var, font=('Segoe UI', 10))
            
            entry.grid(row=i, column=1, sticky=tk.EW, pady=5, padx=(10, 0))
            self.form_vars[key] = var
        
        form_frame.columnconfigure(1, weight=1)
        
        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–æ–π
        button_frame = ttk.Frame(form_frame)
        button_frame.grid(row=len(fields), column=0, columnspan=2, pady=15)
        
        ttk.Button(button_frame, text="–î–æ–±–∞–≤–∏—Ç—å", 
                  command=self.add_product, style='Success.TButton',
                  width=12).pack(side=tk.LEFT, padx=5)
        
        ttk.Button(button_frame, text="–û–±–Ω–æ–≤–∏—Ç—å", 
                  command=self.update_product, style='Primary.TButton',
                  width=12).pack(side=tk.LEFT, padx=5)
        
        ttk.Button(button_frame, text="–û—á–∏—Å—Ç–∏—Ç—å", 
                  command=self.clear_form, width=12).pack(side=tk.LEFT, padx=5)
        
        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º
        monitor_frame = ttk.LabelFrame(parent, text="üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥", padding=15)
        monitor_frame.pack(fill=tk.X, pady=(0, 10))
        
        ttk.Button(monitor_frame, text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ü–µ–Ω—ã", 
                  command=self.update_all_prices, style='Primary.TButton').pack(fill=tk.X, pady=5)
        
        ttk.Button(monitor_frame, text="üöÄ –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ", 
                  command=self.update_selected_price).pack(fill=tk.X, pady=5)
        
        self.auto_update_var = tk.BooleanVar(value=self.config.get('auto_update', False))
        ttk.Checkbutton(monitor_frame, text="–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ", 
                       variable=self.auto_update_var,
                       command=self.toggle_auto_update).pack(anchor=tk.W, pady=5)
        
        # –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        interval_frame = ttk.Frame(monitor_frame)
        interval_frame.pack(fill=tk.X, pady=5)
        
        ttk.Label(interval_frame, text="–ò–Ω—Ç–µ—Ä–≤–∞–ª (–º–∏–Ω):").pack(side=tk.LEFT)
        self.interval_var = tk.StringVar(value=str(self.config.get('update_interval', 300) // 60))
        ttk.Entry(interval_frame, textvariable=self.interval_var, width=8).pack(side=tk.LEFT, padx=5)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ
        info_frame = ttk.LabelFrame(parent, text="‚Ñπ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", padding=15)
        info_frame.pack(fill=tk.BOTH, expand=True)
        
        self.info_text = scrolledtext.ScrolledText(info_frame, 
                                                  height=10,
                                                  font=('Segoe UI', 10),
                                                  wrap=tk.WORD)
        self.info_text.pack(fill=tk.BOTH, expand=True)
        self.info_text.config(state=tk.DISABLED)
    
    def create_data_panel(self, parent):
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö"""
        notebook = ttk.Notebook(parent)
        notebook.pack(fill=tk.BOTH, expand=True)
        
        # –í–∫–ª–∞–¥–∫–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º —Ç–æ–≤–∞—Ä–æ–≤
        products_tab = ttk.Frame(notebook)
        notebook.add(products_tab, text="üìã –¢–æ–≤–∞—Ä—ã")
        
        self.create_products_table(products_tab)
        
        # –í–∫–ª–∞–¥–∫–∞ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏
        charts_tab = ttk.Frame(notebook)
        notebook.add(charts_tab, text="üìä –ì—Ä–∞—Ñ–∏–∫–∏")
        
        self.create_charts_panel(charts_tab)
        
        # –í–∫–ª–∞–¥–∫–∞ —Å –¥–µ—Ç–∞–ª—è–º–∏ —Ç–æ–≤–∞—Ä–∞
        details_tab = ttk.Frame(notebook)
        notebook.add(details_tab, text="üëÅ –î–µ—Ç–∞–ª–∏")
        
        self.create_details_panel(details_tab)
    
    def create_products_table(self, parent):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤"""
        # –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        filter_frame = ttk.Frame(parent)
        filter_frame.pack(fill=tk.X, padx=10, pady=10)
        
        ttk.Label(filter_frame, text="–ü–æ–∏—Å–∫:").pack(side=tk.LEFT, padx=(0, 5))
        
        self.search_var = tk.StringVar()
        self.search_var.trace('w', lambda *args: self.search_products())
        search_entry = ttk.Entry(filter_frame, textvariable=self.search_var, width=30)
        search_entry.pack(side=tk.LEFT, padx=5)
        
        ttk.Button(filter_frame, text="–°–±—Ä–æ—Å", 
                  command=self.reset_filters, width=10).pack(side=tk.LEFT, padx=5)
        
        # –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤
        table_frame = ttk.Frame(parent)
        table_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=(0, 10))
        
        columns = ("ID", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞", "–ò–∑–º–µ–Ω–µ–Ω–∏–µ", "–°—Ç–∞—Ç—É—Å", "–û–±–Ω–æ–≤–ª–µ–Ω–æ")
        
        self.tree = ttk.Treeview(table_frame, columns=columns, show="headings", height=15)
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–ª–æ–Ω–æ–∫
        col_widths = {
            "ID": 50, "–ù–∞–∑–≤–∞–Ω–∏–µ": 250, "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": 120,
            "–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞": 100, "–ò–∑–º–µ–Ω–µ–Ω–∏–µ": 100, "–°—Ç–∞—Ç—É—Å": 100, "–û–±–Ω–æ–≤–ª–µ–Ω–æ": 150
        }
        
        for col in columns:
            self.tree.heading(col, text=col)
            self.tree.column(col, width=col_widths.get(col, 100), anchor=tk.CENTER)
        
        # –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
        vsb = ttk.Scrollbar(table_frame, orient="vertical", command=self.tree.yview)
        self.tree.configure(yscrollcommand=vsb.set)
        
        # –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
        hsb = ttk.Scrollbar(table_frame, orient="horizontal", command=self.tree.xview)
        self.tree.configure(xscrollcommand=hsb.set)
        
        # –†–∞–∑–º–µ—â–µ–Ω–∏–µ
        self.tree.grid(row=0, column=0, sticky=tk.NSEW)
        vsb.grid(row=0, column=1, sticky=tk.NS)
        hsb.grid(row=1, column=0, sticky=tk.EW)
        
        table_frame.grid_rowconfigure(0, weight=1)
        table_frame.grid_columnconfigure(0, weight=1)
        
        # –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
        self.tree.bind('<<TreeviewSelect>>', self.on_product_select)
        self.tree.bind('<Double-1>', self.on_product_double_click)
        
        # –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        self.context_menu = tk.Menu(self.root, tearoff=0)
        self.context_menu.add_command(label="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL", command=self.copy_url)
        self.context_menu.add_command(label="–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ", command=self.open_in_browser)
        self.context_menu.add_separator()
        self.context_menu.add_command(label="–û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É", command=self.update_selected_price)
        self.context_menu.add_command(label="–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é", command=self.show_price_history)
        self.context_menu.add_separator()
        self.context_menu.add_command(label="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä", command=self.delete_product)
        
        self.tree.bind('<Button-3>', self.show_context_menu)
    
    def create_charts_panel(self, parent):
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏"""
        # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        self.charts_container = ttk.Frame(parent)
        self.charts_container.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        ttk.Button(parent, text="–û–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏", 
                  command=self.update_charts, style='Primary.TButton').pack(pady=10)
    
    def create_details_panel(self, parent):
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä–∞"""
        # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        details_container = ttk.Frame(parent)
        details_container.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        image_frame = ttk.LabelFrame(details_container, text="üñº –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", padding=10)
        image_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 10))
        
        self.image_label = ttk.Label(image_frame, 
                                    text="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ\n\n–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞",
                                    font=('Segoe UI', 11),
                                    relief='sunken',
                                    anchor=tk.CENTER)
        self.image_label.pack(fill=tk.BOTH, expand=True)
        
        # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        image_buttons = ttk.Frame(image_frame)
        image_buttons.pack(fill=tk.X, pady=(10, 0))
        
        ttk.Button(image_buttons, text="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª", 
                  command=self.load_image_from_file, width=15).pack(side=tk.LEFT, padx=2)
        
        ttk.Button(image_buttons, text="–ó–∞–≥—Ä—É–∑–∏—Ç—å URL", 
                  command=self.load_image_from_url, width=15).pack(side=tk.LEFT, padx=2)
        
        ttk.Button(image_buttons, text="–£–¥–∞–ª–∏—Ç—å", 
                  command=self.delete_image, width=15).pack(side=tk.LEFT, padx=2)
        
        # –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        info_frame = ttk.LabelFrame(details_container, text="üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", padding=10)
        info_frame.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True)
        
        self.details_text = scrolledtext.ScrolledText(info_frame,
                                                     height=20,
                                                     font=('Segoe UI', 10),
                                                     wrap=tk.WORD)
        self.details_text.pack(fill=tk.BOTH, expand=True)
        self.details_text.config(state=tk.DISABLED)
        
        # –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        action_frame = ttk.Frame(details_container)
        action_frame.pack(fill=tk.X, pady=(10, 0))
        
        ttk.Button(action_frame, text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è", 
                  command=self.save_product_changes, style='Success.TButton').pack(side=tk.LEFT, padx=5)
        
        ttk.Button(action_frame, text="–°–±—Ä–æ—Å", 
                  command=self.reset_details).pack(side=tk.LEFT, padx=5)
    
    def create_status_bar(self, parent):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å –±–∞—Ä–∞"""
        self.status_bar = ttk.Frame(parent, relief=tk.SUNKEN)
        self.status_bar.pack(fill=tk.X, pady=(10, 0))
        
        self.status_label = ttk.Label(self.status_bar, text="–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ", relief=tk.SUNKEN)
        self.status_label.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=2, pady=2)
        
        self.update_time_label = ttk.Label(self.status_bar, text="", width=20)
        self.update_time_label.pack(side=tk.RIGHT, padx=2, pady=2)
        
        # –¢–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
        self.update_clock()
    
    def update_clock(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å—Ç–∞—Ç—É—Å –±–∞—Ä–µ"""
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        self.update_time_label.config(text=f"üïê {current_time}")
        self.root.after(1000, self.update_clock)
    
    def get_categories(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        try:
            cursor = self.conn.cursor()
            cursor.execute("SELECT DISTINCT category FROM products WHERE category != '' ORDER BY category")
            categories = ["–í—Å–µ —Ç–æ–≤–∞—Ä—ã"] + [row[0] for row in cursor.fetchall()]
            return categories
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π: {e}")
            return ["–í—Å–µ —Ç–æ–≤–∞—Ä—ã"]
    
    def filter_by_category(self, event=None):
        """–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        category = self.category_var.get()
        self.load_products(category=category if category != "–í—Å–µ —Ç–æ–≤–∞—Ä—ã" else None)
    
    def load_products(self, category=None, search_text=None):
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        try:
            # –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
            for item in self.tree.get_children():
                self.tree.delete(item)
            
            # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
            query = "SELECT id, name, category, current_price, previous_price, last_updated FROM products WHERE is_active = 1"
            params = []
            
            if category:
                query += " AND category = ?"
                params.append(category)
            
            if search_text:
                query += " AND (name LIKE ? OR category LIKE ?)"
                params.extend([f"%{search_text}%", f"%{search_text}%"])
            
            query += " ORDER BY last_updated DESC"
            
            cursor = self.conn.cursor()
            cursor.execute(query, params)
            products = cursor.fetchall()
            
            self.products = []
            for product in products:
                product_id, name, category, current_price, previous_price, last_updated = product
                
                # –†–∞—Å—á–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã
                change_text = "‚Äî"
                change_percent = 0
                tags = ()
                
                if current_price is not None and previous_price is not None and previous_price > 0:
                    change = current_price - previous_price
                    change_percent = (change / previous_price) * 100
                    
                    if change > 0:
                        change_text = f"‚ñ≤ {change:.2f} ({change_percent:.1f}%)"
                        tags = ('price_up',)
                    elif change < 0:
                        change_text = f"‚ñº {abs(change):.2f} ({abs(change_percent):.1f}%)"
                        tags = ('price_down',)
                    else:
                        change_text = "‚Äî"
                        tags = ('price_same',)
                
                # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
                status = "‚úÖ –í –Ω–∞–ª–∏—á–∏–∏" if current_price is not None else "‚ùì –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω"
                if current_price is not None:
                    cursor.execute("SELECT target_price FROM products WHERE id = ?", (product_id,))
                    target_price_row = cursor.fetchone()
                    if target_price_row and target_price_row[0] and current_price <= target_price_row[0]:
                        status = "üéØ –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞"
                        tags = ('target_reached',)
                
                # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
                price_text = f"{current_price:.2f} ‚ÇΩ" if current_price is not None else "‚Äî"
                
                # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü—É
                item_id = self.tree.insert("", tk.END, values=(
                    product_id, name, category, price_text, change_text, status, last_updated
                ), tags=tags)
                
                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ
                self.products.append(Product(
                    id=product_id,
                    name=name,
                    url="",
                    current_price=current_price,
                    previous_price=previous_price,
                    currency="RUB",
                    last_updated=last_updated,
                    selector_type="CSS",
                    selector_path=""
                ))
            
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–≥–æ–≤ –¥–ª—è —Ü–≤–µ—Ç–æ–≤–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è
            self.tree.tag_configure('price_up', foreground='#e74c3c')  # –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è —Ä–æ—Å—Ç–∞
            self.tree.tag_configure('price_down', foreground='#2ecc71')  # –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è
            self.tree.tag_configure('price_same', foreground='#95a5a6')  # –°–µ—Ä—ã–π –¥–ª—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            self.tree.tag_configure('target_reached', background='#d4edda')  # –ó–µ–ª–µ–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–±–æ–±–æ–∫—Å–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            self.category_combo['values'] = self.get_categories()
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
            self.status_label.config(text=f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {len(products)}")
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤: {e}")
            self.status_label.config(text=f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {e}")
    
    def search_products(self):
        """–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤"""
        search_text = self.search_var.get()
        category = self.category_var.get() if self.category_var.get() != "–í—Å–µ —Ç–æ–≤–∞—Ä—ã" else None
        self.load_products(category=category, search_text=search_text)
    
    def reset_filters(self):
        """–°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤"""
        self.search_var.set("")
        self.category_var.set("–í—Å–µ —Ç–æ–≤–∞—Ä—ã")
        self.load_products()
    
    def on_product_select(self, event):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ"""
        selection = self.tree.selection()
        if not selection:
            return
        
        item = self.tree.item(selection[0])
        product_id = item['values'][0]
        self.current_product_id = product_id
        
        self.load_product_details(product_id)
    
    def on_product_double_click(self, event):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –ø–æ —Ç–æ–≤–∞—Ä—É"""
        self.open_in_browser()
    
    def show_context_menu(self, event):
        """–ü–æ–∫–∞–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é"""
        item = self.tree.identify_row(event.y)
        if item:
            self.tree.selection_set(item)
            self.context_menu.post(event.x_root, event.y_root)
    
    def load_product_details(self, product_id):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä–∞"""
        try:
            cursor = self.conn.cursor()
            cursor.execute("""
                SELECT name, url, category, current_price, previous_price, 
                       currency, last_updated, selector_type, selector_path,
                       target_price, image_data, image_url
                FROM products 
                WHERE id = ?
            """, (product_id,))
            
            product = cursor.fetchone()
            if product:
                name, url, category, current_price, previous_price, currency, \
                last_updated, selector_type, selector_path, target_price, \
                image_data, image_url = product
                
                # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
                self.form_vars['name'].set(name)
                self.form_vars['url'].set(url)
                self.form_vars['category'].set(category)
                self.form_vars['selector'].set(selector_path)
                self.form_vars['target_price'].set(str(target_price) if target_price else "")
                
                # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                self.display_product_image(image_data)
                
                # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π
                details = f"""üì¶ **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ**

**–ù–∞–∑–≤–∞–Ω–∏–µ:** {name}
**–ö–∞—Ç–µ–≥–æ—Ä–∏—è:** {category}
**URL:** {url}

üí∞ **–¶–µ–Ω—ã**
–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: {current_price:.2f} {currency if currency else '‚ÇΩ'}
–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ü–µ–Ω–∞: {previous_price:.2f} {currency if currency else '‚ÇΩ'}
–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞: {target_price:.2f if target_price else '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'} {currency if currency else '‚ÇΩ'}

üìÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {last_updated}
–°–µ–ª–µ–∫—Ç–æ—Ä: {selector_path}
–¢–∏–ø —Å–µ–ª–µ–∫—Ç–æ—Ä–∞: {selector_type}

üîó **–°—Å—ã–ª–∫–∏**
–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {image_url if image_url else '–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ'}"""
                
                self.details_text.config(state=tk.NORMAL)
                self.details_text.delete(1.0, tk.END)
                self.details_text.insert(1.0, details)
                self.details_text.config(state=tk.DISABLED)
                
                # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏
                info_text = f"""–í—ã–±—Ä–∞–Ω —Ç–æ–≤–∞—Ä: {name}
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}
–ü–æ—Å–ª–µ–¥–Ω—è—è —Ü–µ–Ω–∞: {current_price:.2f} {currency if currency else '‚ÇΩ'}
–û–±–Ω–æ–≤–ª–µ–Ω–æ: {last_updated}"""
                
                self.info_text.config(state=tk.NORMAL)
                self.info_text.delete(1.0, tk.END)
                self.info_text.insert(1.0, info_text)
                self.info_text.config(state=tk.DISABLED)
                
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä–∞: {e}")
    
    def display_product_image(self, image_data):
        """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞"""
        if image_data:
            try:
                image = Image.open(io.BytesIO(image_data))
                # –°–æ–∑–¥–∞–µ–º thumbnail —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
                image.thumbnail((300, 300), Image.Resampling.LANCZOS)
                
                # –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π frame –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                bg = Image.new('RGB', (320, 320), color=self.colors['card'])
                bg.paste(image, ((320 - image.width) // 2, (320 - image.height) // 2))
                
                photo = ImageTk.PhotoImage(bg)
                self.image_label.config(image=photo, text="")
                self.image_label.image = photo
                
            except Exception as e:
                logging.error(f"–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
                self.image_label.config(
                    image="",
                    text="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏\n–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
                )
        else:
            self.image_label.config(
                image="",
                text="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ\n\n–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞"
            )
    
    def load_image_from_file(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞"""
        if not self.current_product_id:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä")
            return
        
        file_path = filedialog.askopenfilename(
            title="–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
            filetypes=[
                ("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", "*.jpg *.jpeg *.png *.gif *.bmp *.webp"),
                ("–í—Å–µ —Ñ–∞–π–ª—ã", "*.*")
            ]
        )
        
        if file_path:
            try:
                # –ß—Ç–µ–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                with Image.open(file_path) as img:
                    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ RGB –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    if img.mode in ('RGBA', 'LA'):
                        background = Image.new('RGB', img.size, self.colors['card'])
                        background.paste(img, mask=img.split()[-1] if img.mode == 'RGBA' else None)
                        img = background
                    
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±—É—Ñ–µ—Ä
                    buffer = io.BytesIO()
                    img.save(buffer, format='JPEG', quality=85, optimize=True)
                    image_data = buffer.getvalue()
                
                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
                cursor = self.conn.cursor()
                cursor.execute(
                    "UPDATE products SET image_data = ?, image_url = ? WHERE id = ?",
                    (image_data, f"file://{file_path}", self.current_product_id)
                )
                self.conn.commit()
                
                # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                self.display_product_image(image_data)
                self.status_label.config(text="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ")
                
            except Exception as e:
                logging.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
                messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:\n{e}")
    
    def load_image_from_url(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ URL"""
        if not self.current_product_id:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä")
            return
        
        # –î–∏–∞–ª–æ–≥ –¥–ª—è –≤–≤–æ–¥–∞ URL
        dialog = tk.Toplevel(self.root)
        dialog.title("–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ URL")
        dialog.geometry("500x200")
        dialog.transient(self.root)
        dialog.grab_set()
        
        ttk.Label(dialog, text="–í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", font=('Segoe UI', 11)).pack(pady=10)
        
        url_var = tk.StringVar()
        url_entry = ttk.Entry(dialog, textvariable=url_var, width=50, font=('Segoe UI', 10))
        url_entry.pack(pady=10, padx=20, fill=tk.X)
        url_entry.focus()
        
        def download():
            url = url_var.get().strip()
            if not url:
                messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–í–≤–µ–¥–∏—Ç–µ URL")
                return
            
            if not url.startswith(('http://', 'https://')):
                url = 'https://' + url
            
            try:
                headers = {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                    'Accept': 'image/webp,image/*,*/*;q=0.8',
                    'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7',
                }
                
                response = requests.get(url, headers=headers, timeout=15, stream=True)
                response.raise_for_status()
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                content_type = response.headers.get('content-type', '')
                if not content_type.startswith('image/'):
                    messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "URL –Ω–µ –≤–µ–¥–µ—Ç –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é")
                    return
                
                # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                image_data = response.content
                
                if len(image_data) > 10 * 1024 * 1024:  # 10MB limit
                    messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å. 10MB)")
                    return
                
                # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                image = Image.open(io.BytesIO(image_data))
                if image.mode in ('RGBA', 'LA'):
                    background = Image.new('RGB', image.size, self.colors['card'])
                    background.paste(image, mask=image.split()[-1] if image.mode == 'RGBA' else None)
                    image = background
                
                buffer = io.BytesIO()
                image.save(buffer, format='JPEG', quality=85, optimize=True)
                image_data = buffer.getvalue()
                
                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
                cursor = self.conn.cursor()
                cursor.execute(
                    "UPDATE products SET image_data = ?, image_url = ? WHERE id = ?",
                    (image_data, url, self.current_product_id)
                )
                self.conn.commit()
                
                # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                self.display_product_image(image_data)
                self.status_label.config(text="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ URL")
                dialog.destroy()
                
            except Exception as e:
                logging.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ URL: {e}")
                messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:\n{e}")
        
        button_frame = ttk.Frame(dialog)
        button_frame.pack(pady=20)
        
        ttk.Button(button_frame, text="–ó–∞–≥—Ä—É–∑–∏—Ç—å", 
                  command=download, style='Success.TButton').pack(side=tk.LEFT, padx=10)
        
        ttk.Button(button_frame, text="–û—Ç–º–µ–Ω–∞", 
                  command=dialog.destroy).pack(side=tk.LEFT, padx=10)
    
    def delete_image(self):
        """–£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞"""
        if not self.current_product_id:
            return
        
        if messagebox.askyesno("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", "–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞?"):
            try:
                cursor = self.conn.cursor()
                cursor.execute(
                    "UPDATE products SET image_data = NULL, image_url = NULL WHERE id = ?",
                    (self.current_product_id,)
                )
                self.conn.commit()
                
                self.display_product_image(None)
                self.status_label.config(text="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ")
                
            except Exception as e:
                logging.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
                messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:\n{e}")
    
    def add_product(self):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞"""
        name = self.form_vars['name'].get().strip()
        url = self.form_vars['url'].get().strip()
        category = self.form_vars['category'].get().strip()
        selector = self.form_vars['selector'].get().strip()
        target_price_str = self.form_vars['target_price'].get().strip()
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if not name:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞")
            self.form_vars['name'].focus_set()
            return
        
        if not url:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–í–≤–µ–¥–∏—Ç–µ URL —Ç–æ–≤–∞—Ä–∞")
            self.form_vars['url'].focus_set()
            return
        
        if not url.startswith(('http://', 'https://')):
            url = 'https://' + url
        
        if not selector:
            selector = ".price, .product-price, [itemprop='price']"
        
        try:
            target_price = float(target_price_str) if target_price_str else None
        except ValueError:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞")
            self.form_vars['target_price'].focus_set()
            return
        
        try:
            cursor = self.conn.cursor()
            cursor.execute("""
                INSERT INTO products 
                (name, url, category, selector_path, target_price, last_updated) 
                VALUES (?, ?, ?, ?, ?, ?)
            """, (
                name, 
                url, 
                category if category else "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
                selector,
                target_price,
                datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            ))
            
            self.conn.commit()
            
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã
            product_id = cursor.lastrowid
            self.current_product_id = product_id
            self.update_product_price(product_id)
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            self.load_products()
            self.clear_form()
            
            self.status_label.config(text=f"–¢–æ–≤–∞—Ä '{name}' –¥–æ–±–∞–≤–ª–µ–Ω –∏ –æ–±–Ω–æ–≤–ª–µ–Ω")
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞: {e}")
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä:\n{e}")
    
    def update_product(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ"""
        if not self.current_product_id:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä")
            return
        
        name = self.form_vars['name'].get().strip()
        url = self.form_vars['url'].get().strip()
        category = self.form_vars['category'].get().strip()
        selector = self.form_vars['selector'].get().strip()
        target_price_str = self.form_vars['target_price'].get().strip()
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if not name:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞")
            self.form_vars['name'].focus_set()
            return
        
        if not url:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–í–≤–µ–¥–∏—Ç–µ URL —Ç–æ–≤–∞—Ä–∞")
            self.form_vars['url'].focus_set()
            return
        
        if not url.startswith(('http://', 'https://')):
            url = 'https://' + url
        
        try:
            target_price = float(target_price_str) if target_price_str else None
        except ValueError:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞")
            self.form_vars['target_price'].focus_set()
            return
        
        try:
            cursor = self.conn.cursor()
            cursor.execute("""
                UPDATE products 
                SET name = ?, url = ?, category = ?, selector_path = ?, target_price = ?
                WHERE id = ?
            """, (
                name,
                url,
                category if category else "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
                selector,
                target_price,
                self.current_product_id
            ))
            
            self.conn.commit()
            self.load_products()
            self.load_product_details(self.current_product_id)
            
            self.status_label.config(text=f"–¢–æ–≤–∞—Ä '{name}' –æ–±–Ω–æ–≤–ª–µ–Ω")
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞: {e}")
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä:\n{e}")
    
    def save_product_changes(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–µ—Ç–∞–ª—è—Ö —Ç–æ–≤–∞—Ä–∞"""
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ –¥–µ—Ç–∞–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏
        messagebox.showinfo("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", "–§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏")
    
    def reset_details(self):
        """–°–±—Ä–æ—Å –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä–∞"""
        self.details_text.config(state=tk.NORMAL)
        self.details_text.delete(1.0, tk.END)
        self.details_text.config(state=tk.DISABLED)
        self.image_label.config(image="", text="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ")
    
    def clear_form(self):
        """–û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞"""
        for var in self.form_vars.values():
            var.set("")
        
        self.form_vars['selector'].set(".price, .product-price, [itemprop='price']")
        self.current_product_id = None
    
    def delete_product(self):
        """–£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞"""
        selection = self.tree.selection()
        if not selection:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è")
            return
        
        item = self.tree.item(selection[0])
        product_id = item['values'][0]
        product_name = item['values'][1]
        
        if messagebox.askyesno("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", 
                              f"–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä '{product_name}'?\n–í—Å—è –∏—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω –±—É–¥–µ—Ç —Ç–∞–∫–∂–µ —É–¥–∞–ª–µ–Ω–∞."):
            try:
                cursor = self.conn.cursor()
                cursor.execute("DELETE FROM products WHERE id = ?", (product_id,))
                self.conn.commit()
                
                self.load_products()
                self.clear_form()
                self.status_label.config(text=f"–¢–æ–≤–∞—Ä '{product_name}' —É–¥–∞–ª–µ–Ω")
                
            except Exception as e:
                logging.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞: {e}")
                messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä:\n{e}")
    
    def copy_url(self):
        """–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ URL —Ç–æ–≤–∞—Ä–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞"""
        selection = self.tree.selection()
        if not selection:
            return
        
        item = self.tree.item(selection[0])
        product_id = item['values'][0]
        
        try:
            cursor = self.conn.cursor()
            cursor.execute("SELECT url FROM products WHERE id = ?", (product_id,))
            result = cursor.fetchone()
            if result:
                url = result[0]
                
                self.root.clipboard_clear()
                self.root.clipboard_append(url)
                
                self.status_label.config(text="URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞")
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è URL: {e}")
    
    def open_in_browser(self):
        """–û—Ç–∫—Ä—ã—Ç–∏–µ URL —Ç–æ–≤–∞—Ä–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ"""
        selection = self.tree.selection()
        if not selection:
            return
        
        item = self.tree.item(selection[0])
        product_id = item['values'][0]
        
        try:
            cursor = self.conn.cursor()
            cursor.execute("SELECT url FROM products WHERE id = ?", (product_id,))
            result = cursor.fetchone()
            if result:
                url = result[0]
                
                webbrowser.open(url)
                self.status_label.config(text="–û—Ç–∫—Ä—ã–≤–∞—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ...")
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ: {e}")
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ:\n{e}")
    
    def extract_price(self, html_content, selector):
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏–∑ HTML —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–≤"""
        if not html_content or not selector:
            return None
        
        try:
            soup = BeautifulSoup(html_content, 'html.parser')
            
            # –ú–µ—Ç–æ–¥ 1: CSS —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
            selectors_to_try = selector.split(',')
            selectors_to_try.extend([
                '[data-price]',
                '[itemprop="price"]',
                '.price',
                '.product-price',
                '.price-value',
                '.current-price',
                '.js-price',
                '.c-price',
                '.product-price__value'
            ])
            
            for sel in selectors_to_try:
                sel = sel.strip()
                if not sel:
                    continue
                
                try:
                    elements = soup.select(sel)
                    if elements:
                        price_text = elements[0].get_text().strip()
                        price = self.parse_price_text(price_text)
                        if price:
                            return price
                except Exception:
                    continue
            
            # –ú–µ—Ç–æ–¥ 2: –ü–æ–∏—Å–∫ –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º
            price_patterns = [
                r'(\d{1,3}(?:[.,]\d{3})*(?:[.,]\d{2})?)',  # 1,234.56 –∏–ª–∏ 1.234,56
                r'(\d+(?:[.,]\d+)?)',  # 1234.56 –∏–ª–∏ 1234,56
                r'price["\']?\s*[:=]\s*["\']?([\d.,]+)',  # price: "1234.56"
                r'data-price=["\']?([\d.,]+)'  # data-price="1234.56"
            ]
            
            for pattern in price_patterns:
                matches = re.findall(pattern, html_content, re.IGNORECASE)
                for match in matches:
                    price = self.parse_price_text(match)
                    if price:
                        return price
            
            # –ú–µ—Ç–æ–¥ 3: –ü–æ–∏—Å–∫ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
            script_tags = soup.find_all('script', type='application/ld+json')
            for script in script_tags:
                try:
                    data = json.loads(script.string)
                    if isinstance(data, dict):
                        price = self.extract_from_structured_data(data)
                        if price:
                            return price
                except:
                    continue
            
            return None
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ü–µ–Ω—ã: {e}")
            return None
    
    def parse_price_text(self, text):
        """–ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞ —Å —Ü–µ–Ω–æ–π"""
        try:
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä, —Ç–æ—á–µ–∫ –∏ –∑–∞–ø—è—Ç—ã—Ö
            cleaned = re.sub(r'[^\d.,]', '', text)
            
            if not cleaned:
                return None
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Ç—ã—Å—è—á –∏ –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö
            last_comma = cleaned.rfind(',')
            last_dot = cleaned.rfind('.')
            
            if last_comma > last_dot:
                # –ó–∞–ø—è—Ç–∞—è - –¥–µ—Å—è—Ç–∏—á–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (1.234,56)
                cleaned = cleaned.replace('.', '').replace(',', '.')
            else:
                # –¢–æ—á–∫–∞ - –¥–µ—Å—è—Ç–∏—á–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (1,234.56)
                cleaned = cleaned.replace(',', '')
            
            return float(cleaned)
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ü–µ–Ω—ã '{text}': {e}")
            return None
    
    def extract_from_structured_data(self, data):
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if 'price' in data:
                price = data['price']
                if isinstance(price, (int, float)):
                    return float(price)
                elif isinstance(price, str):
                    return self.parse_price_text(price)
            
            if 'offers' in data:
                offers = data['offers']
                if isinstance(offers, dict) and 'price' in offers:
                    price = offers['price']
                    if isinstance(price, (int, float)):
                        return float(price)
                    elif isinstance(price, str):
                        return self.parse_price_text(price)
                elif isinstance(offers, list) and offers:
                    offer = offers[0]
                    if 'price' in offer:
                        price = offer['price']
                        if isinstance(price, (int, float)):
                            return float(price)
                        elif isinstance(price, str):
                            return self.parse_price_text(price)
            
            return None
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: {e}")
            return None
    
    def update_product_price(self, product_id, force=False):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞"""
        try:
            cursor = self.conn.cursor()
            cursor.execute("""
                SELECT url, selector_path, current_price, name 
                FROM products 
                WHERE id = ? AND is_active = 1
            """, (product_id,))
            
            product = cursor.fetchone()
            if not product:
                return False
            
            url, selector, current_price, name = product
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏ –ª–∏ –º—ã –Ω–µ–¥–∞–≤–Ω–æ
            if not force:
                cursor.execute("SELECT last_updated FROM products WHERE id = ?", (product_id,))
                last_updated_result = cursor.fetchone()
                if last_updated_result and last_updated_result[0]:
                    last_updated_str = last_updated_result[0]
                    try:
                        last_updated = datetime.strptime(last_updated_str, "%Y-%m-%d %H:%M:%S")
                        if datetime.now() - last_updated < timedelta(minutes=5):
                            logging.info(f"–ü—Ä–æ–ø—É—Å–∫–∞–µ–º {name} - –Ω–µ–¥–∞–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–ª–∏")
                            return True
                    except ValueError:
                        pass  # –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            
            logging.info(f"–û–±–Ω–æ–≤–ª—è—é —Ü–µ–Ω—É –¥–ª—è: {name}")
            self.status_label.config(text=f"–û–±–Ω–æ–≤–ª—è—é: {name}")
            
            try:
                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –∑–∞—â–∏—Ç—ã
                headers = {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                    'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7',
                    'Accept-Encoding': 'gzip, deflate, br',
                    'DNT': '1',
                    'Connection': 'keep-alive',
                    'Upgrade-Insecure-Requests': '1',
                    'Sec-Fetch-Dest': 'document',
                    'Sec-Fetch-Mode': 'navigate',
                    'Sec-Fetch-Site': 'none',
                    'Sec-Fetch-User': '?1',
                    'Cache-Control': 'max-age=0',
                }
                
                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é
                session = requests.Session()
                session.headers.update(headers)
                
                # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                time.sleep(1)
                
                response = session.get(url, timeout=20, verify=False)
                response.raise_for_status()
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫—É
                if response.encoding is None:
                    response.encoding = 'utf-8'
                
                new_price = self.extract_price(response.text, selector)
                
                if new_price:
                    logging.info(f"–ù–∞–π–¥–µ–Ω–∞ —Ü–µ–Ω–∞ –¥–ª—è {name}: {new_price}")
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—ã –≤ –ë–î
                    cursor.execute("""
                        UPDATE products 
                        SET previous_price = ?, 
                            current_price = ?, 
                            last_updated = ?,
                            min_price = CASE 
                                WHEN min_price IS NULL OR ? < min_price THEN ? 
                                ELSE min_price 
                            END,
                            max_price = CASE 
                                WHEN max_price IS NULL OR ? > max_price THEN ? 
                                ELSE max_price 
                            END
                        WHERE id = ?
                    """, (
                        current_price,
                        new_price,
                        datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        new_price, new_price,
                        new_price, new_price,
                        product_id
                    ))
                    
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                    cursor.execute("""
                        INSERT OR REPLACE INTO price_history (product_id, price, date)
                        VALUES (?, ?, ?)
                    """, (
                        product_id,
                        new_price,
                        datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                    ))
                    
                    self.conn.commit()
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–π —Ü–µ–Ω—ã
                    cursor.execute("SELECT target_price FROM products WHERE id = ?", (product_id,))
                    target_price_row = cursor.fetchone()
                    
                    if (target_price_row and target_price_row[0] and 
                        new_price <= target_price_row[0] and 
                        (not current_price or new_price < current_price)):
                        self.show_notification(
                            f"üéØ –¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!",
                            f"{name}\n–ù–æ–≤–∞—è —Ü–µ–Ω–∞: {new_price:.2f} ‚ÇΩ\n–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞: {target_price_row[0]:.2f} ‚ÇΩ"
                        )
                    
                    return True
                else:
                    logging.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ü–µ–Ω—É –¥–ª—è {name}")
                    return False
                
            except requests.exceptions.RequestException as e:
                logging.error(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –¥–ª—è {name}: {e}")
                return False
            except Exception as e:
                logging.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω—ã –¥–ª—è {name}: {e}")
                return False
                
        except Exception as e:
            logging.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ {product_id}: {e}")
            return False
    
    def update_selected_price(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞"""
        selection = self.tree.selection()
        if not selection:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
            return
        
        item = self.tree.item(selection[0])
        product_id = item['values'][0]
        product_name = item['values'][1]
        
        self.status_label.config(text=f"–û–±–Ω–æ–≤–ª—è—é {product_name}...")
        self.root.update()
        
        if self.update_product_price(product_id, force=True):
            self.load_products()
            self.load_product_details(product_id)
            self.status_label.config(text=f"–¶–µ–Ω–∞ –¥–ª—è {product_name} –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
        else:
            self.status_label.config(text=f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å {product_name}")
    
    def update_all_prices(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤"""
        try:
            cursor = self.conn.cursor()
            cursor.execute("SELECT id, name FROM products WHERE is_active = 1")
            products = cursor.fetchall()
            
            if not products:
                messagebox.showinfo("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
                return
            
            total = len(products)
            
            # –û–∫–Ω–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            progress_window = tk.Toplevel(self.root)
            progress_window.title("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω")
            progress_window.geometry("400x150")
            progress_window.transient(self.root)
            progress_window.grab_set()
            
            # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
            progress_window.update_idletasks()
            width = progress_window.winfo_width()
            height = progress_window.winfo_height()
            x = (progress_window.winfo_screenwidth() // 2) - (width // 2)
            y = (progress_window.winfo_screenheight() // 2) - (height // 2)
            progress_window.geometry(f'{width}x{height}+{x}+{y}')
            
            ttk.Label(progress_window, 
                     text=f"–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ {total} —Ç–æ–≤–∞—Ä–æ–≤...",
                     font=('Segoe UI', 12)).pack(pady=20)
            
            progress_var = tk.DoubleVar()
            progress_bar = ttk.Progressbar(progress_window, 
                                          variable=progress_var,
                                          maximum=total,
                                          length=300)
            progress_bar.pack(pady=10)
            
            status_label = ttk.Label(progress_window, text="–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...")
            status_label.pack()
            
            def update_process():
                success_count = 0
                
                for i, (product_id, name) in enumerate(products, 1):
                    if self.stop_update:
                        break
                    
                    status_label.config(text=f"–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {name}")
                    progress_var.set(i)
                    progress_window.update()
                    
                    if self.update_product_price(product_id):
                        success_count += 1
                    
                    # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                    time.sleep(2)
                
                progress_window.destroy()
                
                # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                self.load_products()
                self.status_label.config(text=f"–û–±–Ω–æ–≤–ª–µ–Ω–æ {success_count} –∏–∑ {total} —Ç–æ–≤–∞—Ä–æ–≤")
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                if success_count < total:
                    messagebox.showinfo("–†–µ–∑—É–ª—å—Ç–∞—Ç", 
                                       f"‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: {success_count}\n"
                                       f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å: {total - success_count}")
                else:
                    messagebox.showinfo("–£—Å–ø–µ—Ö", f"–í—Å–µ {total} —Ç–æ–≤–∞—Ä–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!")
                
                # –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                self.update_charts()
            
            # –ó–∞–ø—É—Å–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
            thread = threading.Thread(target=update_process, daemon=True)
            thread.start()
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {e}")
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã:\n{e}")
    
    def toggle_auto_update(self):
        """–í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"""
        self.config['auto_update'] = self.auto_update_var.get()
        self.save_config()
        
        if self.config['auto_update']:
            self.start_auto_update()
        else:
            self.stop_auto_update()
    
    def start_auto_update(self):
        """–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"""
        if self.update_thread and self.update_thread.is_alive():
            return
        
        self.stop_update = False
        
        def auto_update_loop():
            while self.config.get('auto_update', False) and not self.stop_update:
                try:
                    interval = self.config.get('update_interval', 300)
                    logging.info(f"–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {interval} —Å–µ–∫—É–Ω–¥")
                    
                    # –ñ–¥–µ–º —É–∫–∞–∑–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
                    for _ in range(interval):
                        if not self.config.get('auto_update', False) or self.stop_update:
                            return
                        time.sleep(1)
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ü–µ–Ω—ã
                    if self.config.get('auto_update', False) and not self.stop_update:
                        logging.info("–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω")
                        self.root.after(0, self.update_all_prices)
                        
                except Exception as e:
                    logging.error(f"–û—à–∏–±–∫–∞ –≤ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: {e}")
                    time.sleep(60)
        
        self.update_thread = threading.Thread(target=auto_update_loop, daemon=True)
        self.update_thread.start()
        
        self.status_label.config(text="–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ")
    
    def stop_auto_update(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"""
        self.stop_update = True
        if self.update_thread and self.update_thread.is_alive():
            self.update_thread.join(timeout=5)
        self.stop_update = False
        self.status_label.config(text="–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")
    
    def show_price_history(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ü–µ–Ω –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞"""
        selection = self.tree.selection()
        if not selection:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä")
            return
        
        item = self.tree.item(selection[0])
        product_id = item['values'][0]
        product_name = item['values'][1]
        
        try:
            cursor = self.conn.cursor()
            cursor.execute("""
                SELECT date, price 
                FROM price_history 
                WHERE product_id = ? 
                ORDER BY date DESC
                LIMIT 100
            """, (product_id,))
            
            history = cursor.fetchall()
            
            if not history:
                messagebox.showinfo("–ò—Å—Ç–æ—Ä–∏—è", f"–î–ª—è —Ç–æ–≤–∞—Ä–∞ '{product_name}' –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω")
                return
            
            # –°–æ–∑–¥–∞–µ–º –æ–∫–Ω–æ —Å –≥—Ä–∞—Ñ–∏–∫–æ–º
            history_window = tk.Toplevel(self.root)
            history_window.title(f"–ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω: {product_name}")
            history_window.geometry("800x600")
            
            # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
            history_window.update_idletasks()
            width = history_window.winfo_width()
            height = history_window.winfo_height()
            x = (history_window.winfo_screenwidth() // 2) - (width // 2)
            y = (history_window.winfo_screenheight() // 2) - (height // 2)
            history_window.geometry(f'{width}x{height}+{x}+{y}')
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            dates = []
            prices = []
            
            for date_str, price in reversed(history):  # –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
                dates.append(datetime.strptime(date_str, "%Y-%m-%d %H:%M:%S"))
                prices.append(price)
            
            # –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
            fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(10, 8))
            
            # –ì—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω
            ax1.plot(dates, prices, marker='o', linestyle='-', color=self.colors['secondary'], linewidth=2)
            ax1.set_title(f'–ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω: {product_name}', fontsize=14, fontweight='bold')
            ax1.set_xlabel('–î–∞—Ç–∞', fontsize=12)
            ax1.set_ylabel('–¶–µ–Ω–∞ (‚ÇΩ)', fontsize=12)
            ax1.grid(True, alpha=0.3)
            ax1.tick_params(axis='x', rotation=45)
            
            # –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            if len(prices) > 1:
                changes = [prices[i] - prices[i-1] for i in range(1, len(prices))]
                colors = ['green' if c < 0 else 'red' for c in changes]
                ax2.bar(range(len(changes)), changes, color=colors, alpha=0.7)
                ax2.set_title('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω', fontsize=14, fontweight='bold')
                ax2.set_xlabel('–ü–µ—Ä–∏–æ–¥', fontsize=12)
                ax2.set_ylabel('–ò–∑–º–µ–Ω–µ–Ω–∏–µ (‚ÇΩ)', fontsize=12)
                ax2.grid(True, alpha=0.3)
            
            plt.tight_layout()
            
            # –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –≤ Tkinter
            canvas = FigureCanvasTkAgg(fig, master=history_window)
            canvas.draw()
            canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
            
            # –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
            table_frame = ttk.Frame(history_window)
            table_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=(0, 10))
            
            columns = ("–î–∞—Ç–∞", "–¶–µ–Ω–∞ (‚ÇΩ)", "–ò–∑–º–µ–Ω–µ–Ω–∏–µ")
            history_tree = ttk.Treeview(table_frame, columns=columns, show="headings", height=8)
            
            for col in columns:
                history_tree.heading(col, text=col)
                history_tree.column(col, width=200)
            
            # –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            prev_price = None
            for date_str, price in history:
                change = ""
                if prev_price is not None:
                    diff = price - prev_price
                    if diff > 0:
                        change = f"‚ñ≤ {diff:.2f}"
                    elif diff < 0:
                        change = f"‚ñº {abs(diff):.2f}"
                    else:
                        change = "‚Äî"
                prev_price = price
                
                history_tree.insert("", tk.END, values=(date_str, f"{price:.2f}", change))
            
            scrollbar = ttk.Scrollbar(table_frame, orient=tk.VERTICAL, command=history_tree.yview)
            history_tree.configure(yscrollcommand=scrollbar.set)
            
            history_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
            scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
            
            # –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
            ttk.Button(history_window, text="üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV", 
                      command=lambda: self.export_history_to_csv(product_id, product_name),
                      style='Success.TButton').pack(pady=10)
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –∏—Å—Ç–æ—Ä–∏–∏: {e}")
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é:\n{e}")
    
    def export_history_to_csv(self, product_id, product_name):
        """–≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω –≤ CSV"""
        try:
            cursor = self.conn.cursor()
            cursor.execute("""
                SELECT date, price 
                FROM price_history 
                WHERE product_id = ? 
                ORDER BY date
            """, (product_id,))
            
            history = cursor.fetchall()
            
            if not history:
                messagebox.showwarning("–≠–∫—Å–ø–æ—Ä—Ç", "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞")
                return
            
            # –ó–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            default_name = f"history_{product_name}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
            file_path = filedialog.asksaveasfilename(
                title="–≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –≤ CSV",
                defaultextension=".csv",
                initialfile=default_name,
                filetypes=[("CSV —Ñ–∞–π–ª—ã", "*.csv"), ("–í—Å–µ —Ñ–∞–π–ª—ã", "*.*")]
            )
            
            if file_path:
                with open(file_path, 'w', newline='', encoding='utf-8') as csvfile:
                    writer = csv.writer(csvfile)
                    writer.writerow(['–î–∞—Ç–∞', '–¶–µ–Ω–∞ (‚ÇΩ)', '–ò–∑–º–µ–Ω–µ–Ω–∏–µ'])
                    
                    prev_price = None
                    for date_str, price in history:
                        change = ""
                        if prev_price is not None:
                            diff = price - prev_price
                            if diff > 0:
                                change = f"+{diff:.2f}"
                            elif diff < 0:
                                change = f"{diff:.2f}"
                        prev_price = price
                        
                        writer.writerow([date_str, f"{price:.2f}", change])
                
                self.status_label.config(text=f"–ò—Å—Ç–æ—Ä–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ {os.path.basename(file_path)}")
                messagebox.showinfo("–£—Å–ø–µ—Ö", f"–ò—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤:\n{file_path}")
                
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏: {e}")
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é:\n{e}")
    
    def update_charts(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤"""
        try:
            # –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            for widget in self.charts_container.winfo_children():
                widget.destroy()
            
            # –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
            self.create_price_distribution_chart()
            self.create_price_changes_chart()
            self.create_category_stats_chart()
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤: {e}")
    
    def create_price_distribution_chart(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–Ω"""
        try:
            cursor = self.conn.cursor()
            cursor.execute("""
                SELECT current_price 
                FROM products 
                WHERE current_price IS NOT NULL AND is_active = 1
            """)
            
            prices = [row[0] for row in cursor.fetchall()]
            
            if not prices:
                ttk.Label(self.charts_container, 
                         text="–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤",
                         font=('Segoe UI', 12)).pack(pady=50)
                return
            
            fig, axes = plt.subplots(1, 3, figsize=(15, 5))
            
            # –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–Ω
            axes[0].hist(prices, bins=20, edgecolor='black', alpha=0.7, color=self.colors['secondary'])
            axes[0].set_title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–Ω', fontsize=12, fontweight='bold')
            axes[0].set_xlabel('–¶–µ–Ω–∞ (‚ÇΩ)', fontsize=10)
            axes[0].set_ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤', fontsize=10)
            axes[0].grid(True, alpha=0.3)
            
            # Box plot
            axes[1].boxplot(prices, vert=True, patch_artist=True,
                           boxprops=dict(facecolor=self.colors['warning']))
            axes[1].set_title('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–µ–Ω', fontsize=12, fontweight='bold')
            axes[1].set_ylabel('–¶–µ–Ω–∞ (‚ÇΩ)', fontsize=10)
            axes[1].grid(True, alpha=0.3)
            
            # –¢–æ–ø 10 —Å–∞–º—ã—Ö –¥–æ—Ä–æ–≥–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
            cursor.execute("""
                SELECT name, current_price 
                FROM products 
                WHERE current_price IS NOT NULL AND is_active = 1
                ORDER BY current_price DESC 
                LIMIT 10
            """)
            
            top_products = cursor.fetchall()
            names = [p[0][:20] + '...' if len(p[0]) > 20 else p[0] for p in top_products]
            top_prices = [p[1] for p in top_products]
            
            y_pos = range(len(names))
            axes[2].barh(y_pos, top_prices, color=self.colors['success'], alpha=0.7)
            axes[2].set_yticks(y_pos)
            axes[2].set_yticklabels(names)
            axes[2].set_title('–¢–æ–ø 10 —Å–∞–º—ã—Ö –¥–æ—Ä–æ–≥–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤', fontsize=12, fontweight='bold')
            axes[2].set_xlabel('–¶–µ–Ω–∞ (‚ÇΩ)', fontsize=10)
            axes[2].grid(True, alpha=0.3)
            
            plt.tight_layout()
            
            # –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
            canvas = FigureCanvasTkAgg(fig, master=self.charts_container)
            canvas.draw()
            canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤: {e}")
    
    def create_price_changes_chart(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ü–µ–Ω"""
        try:
            cursor = self.conn.cursor()
            cursor.execute("""
                SELECT p.name, p.current_price, p.previous_price
                FROM products p
                WHERE p.current_price IS NOT NULL 
                  AND p.previous_price IS NOT NULL
                  AND p.is_active = 1
                LIMIT 20
            """)
            
            products = cursor.fetchall()
            
            if not products:
                return
            
            fig, ax = plt.subplots(figsize=(12, 6))
            
            names = [p[0][:15] + '...' if len(p[0]) > 15 else p[0] for p in products]
            current_prices = [p[1] for p in products]
            previous_prices = [p[2] for p in products]
            
            x = range(len(names))
            width = 0.35
            
            ax.bar([i - width/2 for i in x], previous_prices, width, 
                  label='–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ü–µ–Ω–∞', color=self.colors['warning'], alpha=0.7)
            ax.bar([i + width/2 for i in x], current_prices, width, 
                  label='–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞', color=self.colors['success'], alpha=0.7)
            
            ax.set_xlabel('–¢–æ–≤–∞—Ä—ã', fontsize=12)
            ax.set_ylabel('–¶–µ–Ω–∞ (‚ÇΩ)', fontsize=12)
            ax.set_title('–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ü–µ–Ω', fontsize=14, fontweight='bold')
            ax.set_xticks(x)
            ax.set_xticklabels(names, rotation=45, ha='right')
            ax.legend()
            ax.grid(True, alpha=0.3)
            
            plt.tight_layout()
            
            # –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
            canvas = FigureCanvasTkAgg(fig, master=self.charts_container)
            canvas.draw()
            canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π: {e}")
    
    def create_category_stats_chart(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º"""
        try:
            cursor = self.conn.cursor()
            cursor.execute("""
                SELECT category, 
                       COUNT(*) as count,
                       AVG(current_price) as avg_price,
                       MIN(current_price) as min_price,
                       MAX(current_price) as max_price
                FROM products 
                WHERE category IS NOT NULL 
                  AND category != '' 
                  AND current_price IS NOT NULL
                  AND is_active = 1
                GROUP BY category
                ORDER BY count DESC
                LIMIT 10
            """)
            
            stats = cursor.fetchall()
            
            if not stats:
                return
            
            categories = [s[0][:15] + '...' if len(s[0]) > 15 else s[0] for s in stats]
            counts = [s[1] for s in stats]
            avg_prices = [s[2] for s in stats]
            
            fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 6))
            
            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            colors = plt.cm.Set3(np.linspace(0, 1, len(categories)))
            wedges, texts, autotexts = ax1.pie(counts, labels=categories, colors=colors,
                                              autopct='%1.1f%%', startangle=90)
            ax1.set_title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º', fontsize=14, fontweight='bold')
            
            # –°—Ä–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            y_pos = range(len(categories))
            ax2.barh(y_pos, avg_prices, color=self.colors['secondary'], alpha=0.7)
            ax2.set_yticks(y_pos)
            ax2.set_yticklabels(categories)
            ax2.set_xlabel('–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ (‚ÇΩ)', fontsize=12)
            ax2.set_title('–°—Ä–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º', fontsize=14, fontweight='bold')
            ax2.grid(True, alpha=0.3)
            
            plt.tight_layout()
            
            # –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
            canvas = FigureCanvasTkAgg(fig, master=self.charts_container)
            canvas.draw()
            canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: {e}")
    
    def show_statistics(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        try:
            cursor = self.conn.cursor()
            
            # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            cursor.execute("""
                SELECT 
                    COUNT(*) as total,
                    COUNT(CASE WHEN current_price IS NOT NULL THEN 1 END) as with_price,
                    COUNT(CASE WHEN current_price IS NULL THEN 1 END) as without_price,
                    AVG(current_price) as avg_price,
                    MIN(current_price) as min_price,
                    MAX(current_price) as max_price
                FROM products 
                WHERE is_active = 1
            """)
            
            stats = cursor.fetchone()
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            cursor.execute("""
                SELECT 
                    COUNT(CASE WHEN current_price > previous_price THEN 1 END) as increased,
                    COUNT(CASE WHEN current_price < previous_price THEN 1 END) as decreased,
                    COUNT(CASE WHEN current_price = previous_price THEN 1 END) as unchanged
                FROM products 
                WHERE current_price IS NOT NULL 
                  AND previous_price IS NOT NULL
                  AND is_active = 1
            """)
            
            changes = cursor.fetchone()
            
            # –°–æ–∑–¥–∞–µ–º –æ–∫–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            stats_window = tk.Toplevel(self.root)
            stats_window.title("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
            stats_window.geometry("600x500")
            
            # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
            stats_window.update_idletasks()
            width = stats_window.winfo_width()
            height = stats_window.winfo_height()
            x = (stats_window.winfo_screenwidth() // 2) - (width // 2)
            y = (stats_window.winfo_screenheight() // 2) - (height // 2)
            stats_window.geometry(f'{width}x{height}+{x}+{y}')
            
            # –ó–∞–≥–æ–ª–æ–≤–æ–∫
            ttk.Label(stats_window, 
                     text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞",
                     font=('Segoe UI', 16, 'bold')).pack(pady=20)
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –≤–∏–¥–µ –∫–∞—Ä—Ç–æ—á–µ–∫
            stats_frame = ttk.Frame(stats_window)
            stats_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=10)
            
            # –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
            cards_data = [
                ("–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤", f"{stats[0] if stats else 0}", "üì¶"),
                ("–° —Ü–µ–Ω–∞–º–∏", f"{stats[1] if stats else 0}", "üí∞"),
                ("–ë–µ–∑ —Ü–µ–Ω", f"{stats[2] if stats else 0}", "‚ùì"),
                ("–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞", f"{stats[3]:.2f} ‚ÇΩ" if stats and stats[3] else "‚Äî", "üìä"),
                ("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è", f"{stats[4]:.2f} ‚ÇΩ" if stats and stats[4] else "‚Äî", "üìâ"),
                ("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è", f"{stats[5]:.2f} ‚ÇΩ" if stats and stats[5] else "‚Äî", "üìà"),
            ]
            
            if changes:
                cards_data.extend([
                    ("–¶–µ–Ω—ã –≤—ã—Ä–æ—Å–ª–∏", f"{changes[0]}", "üìà"),
                    ("–¶–µ–Ω—ã —É–ø–∞–ª–∏", f"{changes[1]}", "üìâ"),
                    ("–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π", f"{changes[2]}", "‚û°"),
                ])
            
            # –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —Å–µ—Ç–∫–µ 3x3
            for i, (title, value, icon) in enumerate(cards_data):
                row = i // 3
                col = i % 3
                
                card = ttk.Frame(stats_frame, style='Card.TFrame', padding=15)
                card.grid(row=row, column=col, padx=10, pady=10, sticky=tk.NSEW)
                
                ttk.Label(card, text=icon, font=('Segoe UI', 24)).pack()
                ttk.Label(card, text=title, font=('Segoe UI', 10)).pack()
                ttk.Label(card, text=value, font=('Segoe UI', 14, 'bold')).pack()
            
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–∫–∏
            for i in range(3):
                stats_frame.grid_columnconfigure(i, weight=1)
            
            # –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
            ttk.Button(stats_window, text="–ó–∞–∫—Ä—ã—Ç—å", 
                      command=stats_window.destroy,
                      style='Primary.TButton').pack(pady=20)
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:\n{e}")
    
    def show_settings(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
        settings_window = tk.Toplevel(self.root)
        settings_window.title("‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
        settings_window.geometry("500x600")
        
        # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
        settings_window.update_idletasks()
        width = settings_window.winfo_width()
        height = settings_window.winfo_height()
        x = (settings_window.winfo_screenwidth() // 2) - (width // 2)
        y = (settings_window.winfo_screenheight() // 2) - (height // 2)
        settings_window.geometry(f'{width}x{height}+{x}+{y}')
        
        ttk.Label(settings_window, 
                 text="‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
                 font=('Segoe UI', 16, 'bold')).pack(pady=20)
        
        # –§–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        form_frame = ttk.Frame(settings_window)
        form_frame.pack(fill=tk.BOTH, expand=True, padx=30, pady=10)
        
        settings_vars = {}
        
        # –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        ttk.Label(form_frame, text="–ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–º–∏–Ω—É—Ç):").grid(row=0, column=0, sticky=tk.W, pady=10)
        interval_var = tk.StringVar(value=str(self.config.get('update_interval', 300) // 60))
        ttk.Entry(form_frame, textvariable=interval_var, width=10).grid(row=0, column=1, sticky=tk.W, pady=10)
        settings_vars['update_interval'] = interval_var
        
        # –í–∞–ª—é—Ç–∞
        ttk.Label(form_frame, text="–í–∞–ª—é—Ç–∞:").grid(row=1, column=0, sticky=tk.W, pady=10)
        currency_var = tk.StringVar(value=self.config.get('currency', 'RUB'))
        ttk.Combobox(form_frame, textvariable=currency_var, 
                    values=['RUB', 'USD', 'EUR', 'UAH', 'KZT'], 
                    width=10).grid(row=1, column=1, sticky=tk.W, pady=10)
        settings_vars['currency'] = currency_var
        
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        notifications_var = tk.BooleanVar(value=self.config.get('notifications', True))
        ttk.Checkbutton(form_frame, text="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", 
                       variable=notifications_var).grid(row=2, column=0, columnspan=2, sticky=tk.W, pady=10)
        settings_vars['notifications'] = notifications_var
        
        # –¢–µ–º–∞
        ttk.Label(form_frame, text="–¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:").grid(row=3, column=0, sticky=tk.W, pady=10)
        theme_var = tk.StringVar(value=self.config.get('theme', 'light'))
        ttk.Combobox(form_frame, textvariable=theme_var, 
                    values=['light', 'dark'], 
                    width=10).grid(row=3, column=1, sticky=tk.W, pady=10)
        settings_vars['theme'] = theme_var
        
        form_frame.columnconfigure(1, weight=1)
        
        def save_settings():
            """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
            try:
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ —Å–µ–∫—É–Ω–¥—ã
                try:
                    minutes = int(interval_var.get())
                    self.config['update_interval'] = minutes * 60
                except ValueError:
                    messagebox.showwarning("–û—à–∏–±–∫–∞", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª")
                    return
                
                self.config['currency'] = currency_var.get()
                self.config['notifications'] = notifications_var.get()
                self.config['theme'] = theme_var.get()
                
                self.save_config()
                settings_window.destroy()
                
                messagebox.showinfo("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ", "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
                
            except Exception as e:
                logging.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: {e}")
                messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n{e}")
        
        # –ö–Ω–æ–ø–∫–∏
        button_frame = ttk.Frame(settings_window)
        button_frame.pack(pady=20)
        
        ttk.Button(button_frame, text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", 
                  command=save_settings, style='Success.TButton').pack(side=tk.LEFT, padx=10)
        
        ttk.Button(button_frame, text="–û—Ç–º–µ–Ω–∞", 
                  command=settings_window.destroy).pack(side=tk.LEFT, padx=10)
    
    def export_data(self):
        """–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö"""
        try:
            cursor = self.conn.cursor()
            cursor.execute("""
                SELECT name, category, url, current_price, previous_price, 
                       currency, last_updated, target_price
                FROM products 
                WHERE is_active = 1
                ORDER BY category, name
            """)
            
            products = cursor.fetchall()
            
            if not products:
                messagebox.showinfo("–≠–∫—Å–ø–æ—Ä—Ç", "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞")
                return
            
            # –ó–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            default_name = f"price_monitor_export_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
            file_path = filedialog.asksaveasfilename(
                title="–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö",
                defaultextension=".csv",
                initialfile=default_name,
                filetypes=[
                    ("CSV —Ñ–∞–π–ª—ã", "*.csv"),
                    ("Excel —Ñ–∞–π–ª—ã", "*.xlsx"),
                    ("JSON —Ñ–∞–π–ª—ã", "*.json"),
                    ("–í—Å–µ —Ñ–∞–π–ª—ã", "*.*")
                ]
            )
            
            if not file_path:
                return
            
            ext = os.path.splitext(file_path)[1].lower()
            
            if ext == '.csv':
                # –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                with open(file_path, 'w', newline='', encoding='utf-8-sig') as csvfile:
                    writer = csv.writer(csvfile)
                    writer.writerow(['–ù–∞–∑–≤–∞–Ω–∏–µ', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', 'URL', '–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞', 
                                   '–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ü–µ–Ω–∞', '–í–∞–ª—é—Ç–∞', '–û–±–Ω–æ–≤–ª–µ–Ω–æ', '–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞'])
                    
                    for product in products:
                        writer.writerow(product)
                
                self.status_label.config(text=f"–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ CSV")
                
            elif ext == '.xlsx':
                # –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel (—Ç—Ä–µ–±—É–µ—Ç—Å—è pandas)
                try:
                    import pandas as pd
                    
                    df = pd.DataFrame(products, columns=['–ù–∞–∑–≤–∞–Ω–∏–µ', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', 'URL', '–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞', 
                                                        '–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ü–µ–Ω–∞', '–í–∞–ª—é—Ç–∞', '–û–±–Ω–æ–≤–ª–µ–Ω–æ', '–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞'])
                    df.to_excel(file_path, index=False)
                    
                    self.status_label.config(text=f"–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ Excel")
                    
                except ImportError:
                    messagebox.showerror("–û—à–∏–±–∫–∞", "–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pandas:\npip install pandas")
                    return
                    
            elif ext == '.json':
                # –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
                data = []
                for product in products:
                    data.append({
                        'name': product[0],
                        'category': product[1],
                        'url': product[2],
                        'current_price': product[3],
                        'previous_price': product[4],
                        'currency': product[5],
                        'last_updated': product[6],
                        'target_price': product[7]
                    })
                
                with open(file_path, 'w', encoding='utf-8') as jsonfile:
                    json.dump(data, jsonfile, ensure_ascii=False, indent=2)
                
                self.status_label.config(text=f"–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON")
            
            else:
                # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é CSV
                file_path += '.csv'
                with open(file_path, 'w', newline='', encoding='utf-8-sig') as csvfile:
                    writer = csv.writer(csvfile)
                    writer.writerow(['–ù–∞–∑–≤–∞–Ω–∏–µ', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', 'URL', '–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞', 
                                   '–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ü–µ–Ω–∞', '–í–∞–ª—é—Ç–∞', '–û–±–Ω–æ–≤–ª–µ–Ω–æ', '–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞'])
                    
                    for product in products:
                        writer.writerow(product)
                
                self.status_label.config(text=f"–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ {os.path.basename(file_path)}")
            
            messagebox.showinfo("–£—Å–ø–µ—Ö", f"–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤:\n{file_path}")
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö: {e}")
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ:\n{e}")
    
    def show_notification(self, title, message):
        """–ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
        if not self.config.get('notifications', True):
            return
        
        try:
            # –°–æ–∑–¥–∞–µ–º –æ–∫–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            notification = tk.Toplevel(self.root)
            notification.title(title)
            notification.geometry("400x200")
            
            # –î–µ–ª–∞–µ–º –æ–∫–Ω–æ –ø–æ–≤–µ—Ä—Ö –¥—Ä—É–≥–∏—Ö
            notification.attributes('-topmost', True)
            
            # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
            notification.update_idletasks()
            width = notification.winfo_width()
            height = notification.winfo_height()
            x = (notification.winfo_screenwidth() // 2) - (width // 2)
            y = (notification.winfo_screenheight() // 2) - (height // 2)
            notification.geometry(f'{width}x{height}+{x}+{y}')
            
            # –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            ttk.Label(notification, text="üîî", font=('Segoe UI', 36)).pack(pady=10)
            ttk.Label(notification, text=title, font=('Segoe UI', 14, 'bold')).pack()
            
            message_label = ttk.Label(notification, text=message, font=('Segoe UI', 11))
            message_label.pack(pady=10, padx=20)
            
            # –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
            ttk.Button(notification, text="OK", 
                      command=notification.destroy,
                      style='Success.TButton').pack(pady=10)
            
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
            self.root.after(10000, notification.destroy)
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")
    
    def on_closing(self):
        """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        self.stop_auto_update()
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        if self.conn:
            self.conn.close()
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        self.root.destroy()

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    # –°–æ–∑–¥–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ
    root = tk.Tk()
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    app = PriceMonitorApp(root)
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞
    root.protocol("WM_DELETE_WINDOW", app.on_closing)
    
    # –ó–∞–ø—É—Å–∫ –≥–ª–∞–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
    root.mainloop()

if __name__ == "__main__":
    main()
